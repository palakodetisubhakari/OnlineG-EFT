<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GEFT Online Test</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
    }

    .page {
      display: none;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 15px;
    }

    .active { display: flex; }

    input, select {
      padding: 10px;
      width: 280px;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 12px 25px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover { background:#1d4ed8; }

    canvas {
      border: 2px solid #38bdf8;
      background:#000;
      touch-action: none;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }

    #timer { font-size:20px; color:#22c55e; }
  </style>
</head>
<body>

<div id="infoPage" class="page active">
  <h1>GEFT Online Assessment</h1>

  <p style="max-width:700px;line-height:1.6;text-align:left;">
    <strong>Instructions</strong><br><br>
    You will see complex figures that contain a hidden simple shape. Your task is to locate this hidden shape and trace it directly on the complex image using your stylus or cursor.<br><br>
    Ensure your tracing forms a <strong>closed figure</strong>. Click <strong>Next</strong> to proceed or <strong>Skip</strong> if you cannot identify the shape.<br><br>
    You will have <strong>10 minutes</strong> to attempt the actual test.
  </p>

  <label>Full Name</label>
  <input id="name" placeholder="Enter full name" />

  <label>Age</label>
  <input id="age" type="number" />

  <label>Gender</label>
  <select id="gender">
    <option value="">Select</option>
    <option>Male</option>
    <option>Female</option>
    <option>Other</option>
  </select>

  <p>Which of the following best describes your preferred way of reading and understanding text?</p>

  <select id="preQuestion">
    <option value="">Choose one</option>
    <option value="A">I usually move through the material as it is, staying focused on the overall flow and message.</option>
    <option value="B">I tend to pause and examine specific parts, thinking carefully about details and how they connect.</option>
  </select>

  <button onclick="startMock()">Begin Mock Test</button>
</div>

<div id="testPage" class="page">
  <h2 id="phaseTitle">Mock Question</h2>
  <div id="timer">10:00</div>
  <canvas id="drawCanvas"></canvas>

  <div class="controls">
    <button onclick="clearCanvas()">Clear</button>
    <button onclick="skipQuestion()">Skip</button>
    <button onclick="nextQuestion()">Next</button>
    <button onclick="submitTest()">Submit</button>
  </div>
</div>

<div id="resultPage" class="page"></div>

<script>
const MOCK_COUNT = 2;
const TOTAL_REAL = 18;
let currentIndex = 0;
let phase = 'mock';
let skipped = 0;
let realResults = [];
let timerSeconds = 600;
let timerInterval = null;

let attempt = localStorage.getItem('geft_attempt') ? parseInt(localStorage.getItem('geft_attempt')) + 1 : 1;
localStorage.setItem('geft_attempt', attempt);

let participant = {};

const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');

const infoPage = document.getElementById('infoPage');
const testPage = document.getElementById('testPage');
const resultPage = document.getElementById('resultPage');
const timerDisplay = document.getElementById('timer');
const phaseTitle = document.getElementById('phaseTitle');

const mockImages = ['mock1.png','mock2.png'];
const realImages = Array.from({length: TOTAL_REAL}, (_,i)=>`q${i+1}.png`);

function startMock(){
  const name = nameInput();
  const age = document.getElementById('age').value.trim();
  const gender = document.getElementById('gender').value;
  const pre = document.getElementById('preQuestion').value;

  if(!name || !age || !gender || !pre){ alert('Fill all details'); return; }

  participant = {name,age,gender,pre};
  infoPage.classList.remove('active');
  testPage.classList.add('active');
  loadImage();
}

function nameInput(){ return document.getElementById('name').value.trim(); }

function startTimer(){
  timerInterval = setInterval(()=>{
    let min = Math.floor(timerSeconds/60);
    let sec = timerSeconds%60;
    timerDisplay.textContent = `${min}:${sec<10?'0'+sec:sec}`;
    if(--timerSeconds <=0){ clearInterval(timerInterval); submitTest(); }
  },1000);
}

function loadImage(){
  const img = new Image();
  img.src = phase==='mock' ? mockImages[currentIndex] : realImages[currentIndex];
  phaseTitle.textContent = phase==='mock' ? 'Mock Question' : 'Actual Test';
  img.onload = ()=>{
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
  }
}

function clearCanvas(){ loadImage(); }

let drawing=false,lastX=0,lastY=0;
canvas.addEventListener("pointerdown",e=>{ drawing=true; const r=canvas.getBoundingClientRect(); lastX=e.clientX-r.left; lastY=e.clientY-r.top; });
canvas.addEventListener("pointerup",()=> drawing=false);
canvas.addEventListener("pointermove",e=>{
  if(!drawing) return;
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left,y=e.clientY-r.top;
  ctx.lineWidth=3;ctx.strokeStyle='red';ctx.beginPath();
  ctx.moveTo(lastX,lastY);ctx.lineTo(x,y);ctx.stroke();
  lastX=x;lastY=y;
});

function skipQuestion(){ skipped++; realResults.push({skipped:true,coverage:0}); advance(); }

function nextQuestion(){
  const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let red=0;
  for(let i=0;i<data.length;i+=4){ if(data[i]>150 && data[i+1]<80 && data[i+2]<80) red++; }
  const coverage=red/(canvas.width*canvas.height);
  realResults.push({skipped:false,coverage});
  advance();
}

function advance(){
  currentIndex++;
  if(phase==='mock' && currentIndex>=MOCK_COUNT){ phase='real'; currentIndex=0; startTimer(); }
  if(phase==='real' && currentIndex>=TOTAL_REAL){ submitTest(); return; }
  loadImage();
}

function calculateScore(){
  // Real dynamic scoring based on effort + attempted questions
  const attempted = drawings.length;
  const total = TOTAL_REAL;

  // Analyse how much red was drawn on last canvas
  const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
  let redPixels = 0;
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i + 1], b = data[i + 2];
    if (r > 150 && g < 80 && b < 80) redPixels++;
  }

  const effortRatio = redPixels / (canvas.width * canvas.height);

  // Base score from attempts
  let score = Math.round((attempted / total) * 14);

  // Add drawing effort impact
  score += Math.round(effortRatio * 12);

  // Normalize hard limits
  if (score < 4) score = 4;
  if (score > 20) score = 20;

  return score;
}

function submitTest(){(){
  clearInterval(timerInterval);
  const score = calculateScore();

  const csv = `Name,Age,Gender,Style,Score\n${participant.name},${participant.age},${participant.gender},${participant.pre},${score}`;
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='geft_results.csv';
  a.click();

  testPage.classList.remove('active');
  resultPage.classList.add('active');
  resultPage.innerHTML=`
  <h1>Final Score</h1>
  <h2>${score} / 20</h2>
  <button onclick='location.reload()'>Restart</button>
`;
}
</script>
</body>
</html>
